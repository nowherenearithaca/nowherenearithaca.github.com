<!DOCTYPE html>  <html> <head>   <title>empires.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /><script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-32398449-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               empires.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h2>Summary</h2>

<p>This <a href="http://d3js.org/">D3</a> visualization is by <a href="http://www.visualizing.org/users/edward-lee">Edward Lee</a>, with a 
few minor modifications by <a href="mailto:bradflyon@gmail.com">BFL</a></p>

<p>The (slightly modified) visualization can be viewed <a href="http://nowherenearithaca.github.com/empires/index.html">here</a></p>

<p>Notes by <a href="mailto:bradflyon@gmail.com">BFL</a></p>

<p>The basic structure of this example could probably serve as a nice template for many D3 visualizations, having the
following basic components:</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <ul>
<li><em>initialization</em>
<ul><li>load the data into a <code>data</code> variable</li>
<li>call out to <code>processData</code></li>
<li>construct the basic <code>svg</code> elements from the data and auxiliary objects (e.g., axes ticklines)</li>
<li>configure any click/touch events for the <code>svg</code> elements</li>
<li>kick off the first redraw</li></ul></li>
<li><em>redraw</em>
<ul><li>redraw everything, using transitions for everything</li></ul></li>
<li><em>processData</em>
<ul><li>perform any additional processing on the data for auxiliary quantities</li></ul></li>
<li><em>window resize event</em> ($(window).resize if using jQuery)
<ul><li>determine current visualization bounds based on the window size, etc.</li>
<li>call out to <code>processData</code> to update auxiliary quantities</li>
<li>call <code>redraw</code></li></ul></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h2>Variables</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>The current width and height of the visualization; this will change if the window size changes</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">wid</span><span class="p">,</span> <span class="nx">hei</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>How long the transitions should last, in milliseconds</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">transitionDuration</span> <span class="o">=</span> <span class="mi">800</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>The data that is loaded from the file</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">data</span> <span class="o">=</span> <span class="p">[];</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p><code>scales</code> holds the various scales used for rendering, and some helper utility functions:</p>

<ul>
<li><code>scales.years</code>
<ul><li><a href="https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-linear_domain">d3 linear scale</a> that maps [minYear,maxYear] to [padding.left, wid - padding.right] (the horizontal pixel bounds of the visualization)</li>
<li>this is used to get the proper x location on the screen given a year, handling a <em>lot</em> of grunt work in a nice way</li></ul></li>
<li><code>scales.indexes</code>
<ul><li><a href="https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-linear_domain">d3 linear scale</a> that maps
  [0, data.length - 1] to [padding.top, hei - padding.bottom - barHeight]</li>
<li>this is used to determine the y location of a bar when fixed heights are being used</li></ul></li>
<li><code>scales.areas</code>(<em>area</em>)
<ul><li>function that takes an area and returns the height in pixels that that area represents, as a fraction of the total overall empire areas</li></ul></li>
<li><code>scales.popPercents</code>(<em>popPercent</em>)
<ul><li>function that takes a population percent and returns the height in pixels that that population percent represents, as a fraction of the total overall empire areas</li></ul></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">scales</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><code>totals</code> holds some auxiliary quantities calculated during initialization:</p>

<ul>
<li><code>totals.area</code> is the sum of area over all empires</li>
<li><code>totals.population</code> is the sum of population over all empires</li>
<li><code>totals.popPercent</code> is the sum of population percent over all empires</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">totals</span> <span class="o">=</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p><code>vis</code> is the main html/svg element that contains all of the graphics</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">vis</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Set some "comfortable" padding around the visualization</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">padding</span> <span class="o">=</span> <span class="p">{</span>
	<span class="nx">top</span> <span class="o">:</span> <span class="mi">40</span><span class="p">,</span>
	<span class="nx">right</span> <span class="o">:</span> <span class="mi">140</span><span class="p">,</span>
	<span class="nx">bottom</span> <span class="o">:</span> <span class="mi">30</span><span class="p">,</span>
	<span class="nx">left</span> <span class="o">:</span> <span class="mi">30</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>The initial barHeight for the bars; this will be changed based on the actual data and window height</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">barHeight</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>If the percentage of total population is not defined for a given empire, then use this default value</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">defaultPopPercent</span> <span class="o">=</span> <span class="p">.</span><span class="mi">08</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>The <code>controls</code> variable holds the current view option settings, as set by clicking one of the links in the "controls" portion of the screen</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <ul>
<li><code>controls.display</code> - how the bars are placed horizontally
<ul><li>"timeline": each bar is placed horizontally where its start year is</li>
<li>"centered": each bar is placed so that the peak year of the corresponding empire is in the center of the screen</li>
<li>"aligned": bars are all placed on far left of visualization (this is the fallback if controls.display is not one of the other two possible values)</li></ul></li>
<li><code>controls.height</code> - how the height of each bar is determined
<ul><li>"fixed": the height of each bar is the same, and is calculated based on the vertical screen size of the visualization</li>
<li>"area": the height of each bar corresponds to how much of the total area over all of the empires, thus providing a way to visually compare the size of each empire</li>
<li>"population": the height of each bar correspond to how much of the total population percentage over all of the empires, thus providing a way to visually compare the fraction of world population of each empire</li></ul></li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">var</span> <span class="nx">controls</span> <span class="o">=</span> <span class="p">{</span>
	<span class="nx">display</span> <span class="o">:</span> <span class="s2">&quot;aligned&quot;</span><span class="p">,</span>
	<span class="nx">height</span> <span class="o">:</span> <span class="s2">&quot;fixed&quot;</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h2>Initialization</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>This is the <a href="http://api.jquery.com/ready/">jQuery callback called when the DOM is fully loaded</a></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>This will create the <code>&lt;svg&gt;</code> html element, so that you end up with this:</p>

<blockquote>
  <p><code>&lt;body&gt;&lt;svg class="vis"&gt;</code> <br/></p>
</blockquote>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Note that D3 can handle this particular case if you just use "<em>svg</em>" instead of "<em>svg:svg</em>"</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">vis</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">select</span><span class="p">(</span><span class="s2">&quot;body&quot;</span><span class="p">)</span>
			<span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:svg&quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;vis&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Set the size of the div based on the current size of the window; this method
is called every time the window is resized, too</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">setVisSize</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h3>Load the Data</h3>

<p>Internally, the <code>d3.csv</code> function uses an ajax call to load the raw data;
if you're working on a local file system, you need to tweak d3
to handle ajax calls to local files, a la <a href="https://github.com/mbostock/d3/pull/632">this pull request for D3</a>.
For local file stuff to work on Chrome, you need to also enable local file access
via something like <code>--allow-file-access-from-files</code>, but I haven't tried it yet.</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">d3</span><span class="p">.</span><span class="nx">csv</span><span class="p">(</span><span class="s2">&quot;Empires_Data.csv&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>

		<span class="nx">data</span> <span class="o">=</span> <span class="nx">d</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <h3>Parse the data</h3>

<p>Each line of the csv file results in an element in the <code>data</code> array</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">d</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Do a little bit of cleanup/converting</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">for</span> <span class="p">(</span><span class="nx">prop</span> <span class="k">in</span> <span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="nx">prop</span><span class="p">]))</span> <span class="p">{</span>
					<span class="nx">d</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="nx">prop</span><span class="p">]);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Yes&quot;</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">d</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;No&quot;</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">d</span><span class="p">[</span><span class="nx">prop</span><span class="p">]</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <h3>Do sort and calculate totals</h3>

<p>This is not in <code>processData</code> because we only need to do it once, as the source data do not change after being loaded</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>Sort the data by start year for the empire, using the <a href="https://github.com/mbostock/d3/wiki/Arrays#wiki-d3_ascending">d3 <code>ascending</code> utility method</a></p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">data</span><span class="p">.</span><span class="nx">sort</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">,</span> <span class="nx">b</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">ascending</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">Start</span><span class="p">,</span> <span class="nx">b</span><span class="p">.</span><span class="nx">Start</span><span class="p">);</span>
		<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Calculate the total area of all empires, using the <a href="https://github.com/mbostock/d3/wiki/Arrays#wiki-d3_sum">d3 <code>sum</code> utility method</a></p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">totals</span><span class="p">.</span><span class="nx">area</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">sum</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Land_area_million_km2</span><span class="p">;</span>
		<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Calculate the total population of all empires, using the <a href="https://github.com/mbostock/d3/wiki/Arrays#wiki-d3_sum">d3 <code>sum</code> utility method</a></p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">totals</span><span class="p">.</span><span class="nx">population</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">sum</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Estimated_Population</span><span class="p">;</span>
		<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Calculate the sum of the population percentage over  of all empires, using the
<a href="https://github.com/mbostock/d3/wiki/Arrays#wiki-d3_sum">d3 <code>sum</code> utility method</a>; some of the records do not have the population percentage defined,
so these must be dealt somehow, in this case returning the default
population percentage (of 0.08)</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">totals</span><span class="p">.</span><span class="nx">popPercent</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">sum</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Percent_World_Population</span><span class="p">))</span>
				<span class="k">return</span> <span class="nx">defaultPopPercent</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Percent_World_Population</span><span class="p">;</span>
		<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Process data for scales, etc. (see notes below)</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">processData</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Some more initialization (these methods only called once; see notes below)</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">drawStarting</span><span class="p">();</span>
		<span class="nx">addInteractionEvents</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Set the initial options for controls.display and controls.height, after a wait of 500ms (for a bit of a dramatic effect :) )</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">setTimeout</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Set the initial "controls.display" option to "timeline", and do not redraw</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">setControl</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#controls #layoutControls #layout-timeline&quot;</span><span class="p">),</span> <span class="s2">&quot;display&quot;</span><span class="p">,</span> <span class="s2">&quot;timeline&quot;</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Set the initial "controls.height" option to "area", and redraw</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">setControl</span><span class="p">(</span><span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#controls #heightControls #height-area&quot;</span><span class="p">),</span> <span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="s2">&quot;area&quot;</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
		<span class="p">},</span> <span class="mi">500</span><span class="p">);</span>

	<span class="p">});</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <h2>Set the Width and Height of the Visualization</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>These calculations are based on the current window size</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">setVisSize</span><span class="p">()</span> <span class="p">{</span>

	<span class="nx">wid</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">width</span><span class="p">()</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="nx">hei</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">height</span><span class="p">()</span> <span class="o">-</span> <span class="mi">25</span> <span class="o">-</span> <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#controls&quot;</span><span class="p">).</span><span class="nx">height</span><span class="p">();</span>
	<span class="nx">vis</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="nx">wid</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="nx">hei</span><span class="p">);</span> <span class="c1">//works in firefox; </span>
	<span class="cm">/*</span>
<span class="cm">	 The original $(&quot;.vis&quot;).attr(&quot;width&quot;, wid);//does not work in firefox</span>
<span class="cm">	 */</span>
	<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.vis .background&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="nx">wid</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="nx">hei</span><span class="p">);</span>

<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>Note: You need to be careful how you set the width/height attributes, because the jQuery selectors might not work correctly on Firefox.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <h2>Hook into Window Resize Event</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>This uses <a href="http://api.jquery.com/resize/">jQuery's resize</a> to get notified when the window's size is changed</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">setVisSize</span><span class="p">();</span>
	<span class="nx">processData</span><span class="p">();</span>
	<span class="nx">redraw</span><span class="p">();</span>
<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <h2>Recalculate Scales, etc. based on Current Window Size</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/************************************************************</span>
<span class="cm"> * Process the data once it&#39;s imported</span>
<span class="cm"> ***********************************************************/</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p><code>processData</code> is called every time the screen is resized.
It sets <code>scales.years</code>, <code>scales.indexes</code>, <code>scales.areas</code>,  <code>scales.popPercents</code></p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">processData</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p><code>barHeight</code> is used for the fixed size case</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">barHeight</span> <span class="o">=</span> <span class="p">(</span><span class="nx">hei</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">bottom</span><span class="p">)</span> <span class="o">/</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Configure the <code>scales</code> functions</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">scales</span><span class="p">.</span><span class="nx">years</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">()</span>
					<span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="nx">d3</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Start</span><span class="p">;}),</span> 
							<span class="nx">d3</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">End</span><span class="p">;})])</span>
					<span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="nx">padding</span><span class="p">.</span><span class="nx">left</span><span class="p">,</span> <span class="nx">wid</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">right</span><span class="p">]);</span>

	<span class="nx">scales</span><span class="p">.</span><span class="nx">indexes</span> <span class="o">=</span> <span class="nx">d3</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">linear</span><span class="p">()</span>
					<span class="p">.</span><span class="nx">domain</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>
					<span class="p">.</span><span class="nx">range</span><span class="p">([</span><span class="nx">padding</span><span class="p">.</span><span class="nx">top</span><span class="p">,</span> <span class="nx">hei</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">bottom</span> <span class="o">-</span> <span class="nx">barHeight</span><span class="p">]);</span>

	<span class="nx">scales</span><span class="p">.</span><span class="nx">areas</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">percentage</span> <span class="o">=</span> <span class="nx">a</span> <span class="o">/</span> <span class="nx">totals</span><span class="p">.</span><span class="nx">area</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="nx">hei</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">bottom</span><span class="p">;</span>
		<span class="k">return</span> <span class="nx">range</span> <span class="o">*</span> <span class="nx">percentage</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="nx">scales</span><span class="p">.</span><span class="nx">popPercents</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">a</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">a</span><span class="p">))</span>
			<span class="nx">a</span> <span class="o">=</span> <span class="nx">defaultPopPercent</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">percentage</span> <span class="o">=</span> <span class="nx">a</span> <span class="o">/</span> <span class="nx">totals</span><span class="p">.</span><span class="nx">popPercent</span><span class="p">;</span>
		<span class="kd">var</span> <span class="nx">range</span> <span class="o">=</span> <span class="nx">hei</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">top</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">bottom</span><span class="p">;</span>
		<span class="k">return</span> <span class="nx">range</span> <span class="o">*</span> <span class="nx">percentage</span><span class="p">;</span>
	<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Determine the y location for each bar for the case where height of each bar is proportional to the area of the corresponding empire</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">y_area</span> <span class="o">=</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">d</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
		<span class="nx">d</span><span class="p">.</span><span class="nx">area_y</span> <span class="o">=</span> <span class="nx">y_area</span><span class="p">;</span>
		<span class="nx">y_area</span> <span class="o">+=</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">areas</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Land_area_million_km2</span><span class="p">);</span>
	<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Determine the y location for each bar for the case where height of each bar is proportional to the population percentage</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">y_popPercent</span> <span class="o">=</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">top</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">d</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
		<span class="nx">d</span><span class="p">.</span><span class="nx">popPercent_y</span> <span class="o">=</span> <span class="nx">y_popPercent</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Percent_World_Population</span><span class="p">))</span>
			<span class="nx">y_popPercent</span> <span class="o">+=</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">popPercents</span><span class="p">(</span><span class="nx">defaultPopPercent</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="nx">y_popPercent</span> <span class="o">+=</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">popPercents</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Percent_World_Population</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <h2>Initial Render (called only once)</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/************************************************************</span>
<span class="cm"> * Initial rendering of the vis</span>
<span class="cm"> ***********************************************************/</span>
<span class="kd">function</span> <span class="nx">drawStarting</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <h3>The Main <em>rect</em> Containing the Visualization</h3>             </td>             <td class="code">               <div class="highlight"><pre>	</pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <ol>
<li>Create a new <a href="http://www.w3.org/TR/SVG/shapes.html#RectElement">svg <code>rect</code> element</a> under the main visualization element</li>
<li>Set its CSS class to "background"</li>
<li>Set its <code>x</code> attribute to 0</li>
<li>Set its <code>y</code> attribute to 0</li>
<li>Set its width to the current window width (as calculated in <code>setVisSize()</code>)</li>
<li>Set its height to the current window height (as calculated in <code>setVisSize()</code>)</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">vis</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:rect&quot;</span><span class="p">)</span>
		<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;background&quot;</span><span class="p">)</span>
		<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="nx">wid</span><span class="p">)</span>
		<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="nx">hei</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <h3>Initialize the Year Ticks</h3>

<ol>
<li>Select all of the <code>line</code> elements (which won't exist yet)</li>
<li>Attach data returned from the <a href="https://github.com/mbostock/d3/wiki/Quantitative-Scales#wiki-linear_ticks">D3 ticks function</a>; there will be 10 uniformly-spaced values in the dataset</li>
<li>Begin the process for what to do with new data (the <code>enter()</code> call)</li>
<li>For each new one, append an <a href="http://www.w3.org/TR/SVG/shapes.html#LineElement">svg <code>line</code> element</a></li>
<li>Set the CSS <code>class</code> for this line to "tickLine"</li>
<li>Set the <code>x1</code> attribute for the line to the left-most position in the visualization</li>
<li>Set the <code>x2</code> attribute for the line to the left-most position in the visualization</li>
<li>Set the <code>y1</code> attribute for the line to the yop-most position in the visualization</li>
<li>Set the <code>y2</code> attribute for the line to the bottom-most position in the visualization</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>	
	<span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;line&quot;</span><span class="p">)</span>
		<span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">scales</span><span class="p">.</span><span class="nx">years</span><span class="p">.</span><span class="nx">ticks</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
		<span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
			<span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:line&quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;tickLine&quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">left</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">left</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">top</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="nx">hei</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">bottom</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <h3>Empire Containers</h3>

<ol>
<li>Select all of the <code>g</code> elements</li>
<li>Attach the <code>data</code> to these elements</li>
<li>Begin the process for what to do with new data (the <code>enter()</code> call)</li>
<li>For each new one, append an <a href="http://www.w3.org/TR/SVG/struct.html#Groups">svg <code>g</code> element</a> </li>
<li>Set the CSS <code>class</code> of the element to "barGroup"</li>
<li>Set the <code>index</code> attribute for use later when the bar is clicked and we need to know which one it was</li>
<li>Set the <code>transform</code> attribute to be a translation to where the left is always
   the far-most left, and the y location depends on the data row; the left position will
   will be modified each time in the redraw method by transition calls based on which options are chosen</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
		<span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span>
		<span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
			<span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:g&quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;barGroup&quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="nx">i</span><span class="p">;})</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">return</span> <span class="s2">&quot;translate(&quot;</span> <span class="o">+</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">left</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">indexes</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
				 <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <h3>Bars</h3>

<ol>
<li>Select all of the <code>g.barGroup</code> elements (these will have been created in the call above, and have the <code>data</code> attached to them)</li>
<li>For each one, append an <a href="http://www.w3.org/TR/SVG/shapes.html#RectElement">svg <code>rect</code></a> element</li>
<li>For this new rect, set its class to <code>bar</code></li>
<li>Set the x attribute to 0</li>
<li>Set the y attribute to 0</li>
<li>Set the width of the rect to a function that returns the (scaled) distance between the end and start years for the data row</li>
<li>Set the height attribute to the initial default barHeight above (this will be reset in the redraw method)</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;g.barGroup&quot;</span><span class="p">)</span>
			<span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:rect&quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;width&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
							<span class="k">return</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">years</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">End</span><span class="p">)</span> <span class="o">-</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">years</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Start</span><span class="p">);</span>
							<span class="p">})</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="nx">barHeight</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <h3>Empire Peak Lines</h3>

<ol>
<li>Select all <code>g.barGroup</code> elements</li>
<li>For each one, append an <a href="http://www.w3.org/TR/SVG/shapes.html#LineElement">svg <code>line</code> element</a></li>
<li>Set the CSS class for this new line to "peakLine"</li>
<li>Set the x1 attribute for the line to be a function that returns where the peak for that data point fits during the time period for the empire</li>
<li>Set the x2 attribute for the line to be the same function as for x1</li>
<li>Set the y1 attribute to be 0 (which is the top of the barGroup the line is in)</li>
<li>Set the y2 attribute for the line to be the current generic barHeight (this will be reset in the redraw method based on the current options)</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;g.barGroup&quot;</span><span class="p">)</span>
			<span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:line&quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;peakLine&quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">years</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Peak</span><span class="p">)</span> <span class="o">-</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">years</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Start</span><span class="p">);</span>
					<span class="p">})</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">years</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Peak</span><span class="p">)</span> <span class="o">-</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">years</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Start</span><span class="p">);</span>
					<span class="p">})</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="nx">barHeight</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <h3>Bar Labels</h3>

<ol>
<li>Select all of the <code>g.barGroup</code> elements</li>
<li>For each one, append an <a href="http://www.w3.org/TR/SVG/text.html#TextElement">svg <code>text</code> element</a></li>
<li>Set the CSS class for this new element to be "barLabel"</li>
<li>Set the x value to be a function that returns the width of the bar</li>
<li>Set the y atrribute of the <code>text</code> element to be 0</li>
<li>Set the <code>dx</code> attribute to 5 pixels to give a little space next to the bar</li>
<li>Set the <code>dy</code> property to be a tad down from 0 at 0.35em</li>
<li>Set the inline css style <code>fill</code> to be the color #0ff IF this empire has contiguous = false</li>
<li>Set the text itself to be d.name (will be actual contents of the tag itself)</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;g.barGroup&quot;</span><span class="p">)</span>
			<span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:text&quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;barLabel&quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">years</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">End</span><span class="p">)</span> <span class="o">-</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">years</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Start</span><span class="p">);</span>
					<span class="p">})</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;dx&quot;</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;dy&quot;</span><span class="p">,</span> <span class="s2">&quot;.35em&quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Contiguous</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span>
							<span class="k">return</span> <span class="s2">&quot;#0ff&quot;</span><span class="p">;</span>
					<span class="p">})</span>
				<span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Name</span><span class="p">;</span>
					<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <h3>Tick Labels</h3>

<ol>
<li>Select all of the <code>text.rule</code> elements (which might not exist yet, which is ok as they can be created after the data has been added)</li>
<li>Attach the data to these elements, being the 10 tick marks</li>
<li>Indicate what to do for new data</li>
<li>For each new data, add an <a href="http://www.w3.org/TR/SVG/text.html#TextElement">svg <code>text</code> element</a></li>
<li>Set its CSS class to "rule"</li>
<li>Set the x attribute to padding.left for each one (will be reset in redraw based on other options)</li>
<li>Set the y attribute to be a constant 20 (this is relative to the containing element)</li>
<li>Set the dy attribute to 0 (maybe this was twiddled at some point)</li>
<li>Set the <code>tedxt-anchor</code> attribute to "middle" to center the text</li>
<li>Set the text for the element as the function that returns the formatted year for the data point</li>
<li>Set the initial opacity to 0; this will be transitioned to the proper value in the redraw function</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;text.rule&quot;</span><span class="p">)</span>
		<span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="nx">scales</span><span class="p">.</span><span class="nx">years</span><span class="p">.</span><span class="nx">ticks</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
		<span class="p">.</span><span class="nx">enter</span><span class="p">()</span>
			<span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="s2">&quot;svg:text&quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;rule&quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">left</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;dy&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;text-anchor&quot;</span><span class="p">,</span> <span class="s2">&quot;middle&quot;</span><span class="p">)</span>
				<span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="nx">formatYear</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
					<span class="p">})</span>
				<span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill-opacity&quot;</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <h2>redraw</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/************************************************************</span>
<span class="cm"> * Redraw the vis with transition</span>
<span class="cm"> ***********************************************************/</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Redraw everything, using a transition for each thing rendered every time</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Things are rendered from back to front:</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <ul>
<li>year ticklines ("line.tickline")</li>
<li>empire containers ("g")</li>
<li>bars ("g.barGroup rect.bar")</li>
<li>bar labels ("g.barGroup text.barLabel")</li>
<li>peak lines ("g.barGroup line.peakLine")</li>
<li>tick labels ("text.rule")</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">redraw</span><span class="p">()</span> <span class="p">{</span>

	<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#infobox&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p>Calculate the horizontal center of the rendering area for later use</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">visCenter</span> <span class="o">=</span> <span class="p">(</span><span class="nx">wid</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">left</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <h3>redraw the Year Ticks</h3>

<p>The ticklines are shown either at the specified tick intervals, bunched up in the middle,
      or all the way to the left; the top and bottom are the height of the
      container minus the padding</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;line.tickLine&quot;</span><span class="p">)</span>
		<span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="nx">transitionDuration</span><span class="p">)</span>
			<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">display</span> <span class="o">==</span> <span class="s2">&quot;timeline&quot;</span><span class="p">)</span>
						<span class="k">return</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">years</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">display</span> <span class="o">==</span> <span class="s2">&quot;centered&quot;</span><span class="p">)</span>
						<span class="k">return</span> <span class="nx">visCenter</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="k">return</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
				<span class="p">})</span>
			<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x2&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">display</span> <span class="o">==</span> <span class="s2">&quot;timeline&quot;</span><span class="p">)</span>
						<span class="k">return</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">years</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">display</span> <span class="o">==</span> <span class="s2">&quot;centered&quot;</span><span class="p">)</span>
						<span class="k">return</span> <span class="nx">visCenter</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="k">return</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
				<span class="p">})</span>
			<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y1&quot;</span><span class="p">,</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">top</span><span class="p">)</span>
			<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="nx">hei</span> <span class="o">-</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">bottom</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <h3>redraw the Empire Containers</h3>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;g&quot;</span><span class="p">)</span>
		<span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="nx">transitionDuration</span><span class="p">)</span>
			<span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill-opacity&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">height</span> <span class="o">==</span> <span class="s2">&quot;population&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Percent_World_Population</span><span class="p">))</span>
						<span class="k">return</span> <span class="p">.</span><span class="mi">4</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">})</span>
			<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;transform&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">tx</span><span class="p">,</span> <span class="nx">ty</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">display</span> <span class="o">==</span> <span class="s2">&quot;timeline&quot;</span><span class="p">)</span>
					<span class="nx">tx</span> <span class="o">=</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">years</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Start</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">display</span> <span class="o">==</span> <span class="s2">&quot;centered&quot;</span><span class="p">)</span>
					<span class="nx">tx</span> <span class="o">=</span> <span class="nx">visCenter</span> <span class="o">-</span> <span class="p">(</span><span class="nx">scales</span><span class="p">.</span><span class="nx">years</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Peak</span><span class="p">)</span> <span class="o">-</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">years</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Start</span><span class="p">));</span>
				<span class="k">else</span>
					<span class="nx">tx</span> <span class="o">=</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">height</span> <span class="o">==</span> <span class="s2">&quot;area&quot;</span><span class="p">)</span>
					<span class="nx">ty</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">area_y</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">height</span> <span class="o">==</span> <span class="s2">&quot;population&quot;</span><span class="p">)</span>
					<span class="nx">ty</span> <span class="o">=</span> <span class="nx">d</span><span class="p">.</span><span class="nx">popPercent_y</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="nx">ty</span> <span class="o">=</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">indexes</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
				<span class="k">return</span> <span class="s2">&quot;translate(&quot;</span> <span class="o">+</span> <span class="nx">tx</span> <span class="o">+</span> <span class="s2">&quot;, &quot;</span> <span class="o">+</span> <span class="nx">ty</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">;</span>
				<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <h3>redraw the Bars</h3>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;g.barGroup rect.bar&quot;</span><span class="p">)</span>
		<span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="nx">transitionDuration</span><span class="p">)</span>
			<span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill-opacity&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">height</span> <span class="o">==</span> <span class="s2">&quot;population&quot;</span> <span class="o">&amp;&amp;</span> <span class="nb">isNaN</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Percent_World_Population</span><span class="p">))</span>
						<span class="k">return</span> <span class="p">.</span><span class="mi">25</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="k">return</span> <span class="p">.</span><span class="mi">75</span><span class="p">;</span>
				<span class="p">})</span>
			<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;height&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">height</span> <span class="o">==</span> <span class="s2">&quot;area&quot;</span><span class="p">)</span>
						<span class="k">return</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">areas</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Land_area_million_km2</span><span class="p">);</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">height</span> <span class="o">==</span> <span class="s2">&quot;population&quot;</span><span class="p">)</span>
						<span class="k">return</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">popPercents</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Percent_World_Population</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="k">return</span> <span class="nx">barHeight</span><span class="p">;</span>
				<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <h3>redraw the Bar Labels</h3>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">labelHeight</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;g.barGroup text.barLabel&quot;</span><span class="p">)</span>
		<span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="nx">transitionDuration</span><span class="p">)</span>
			<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">height</span> <span class="o">==</span> <span class="s2">&quot;area&quot;</span><span class="p">)</span>
						<span class="k">return</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">areas</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Land_area_million_km2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="nx">labelHeight</span><span class="p">;</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">height</span> <span class="o">==</span> <span class="s2">&quot;population&quot;</span><span class="p">)</span>
						<span class="k">return</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">popPercents</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Percent_World_Population</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="nx">labelHeight</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="k">return</span> <span class="nx">barHeight</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="nx">labelHeight</span><span class="p">;</span>
				<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <h3>redraw the Peak Lines</h3>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;g.barGroup line.peakLine&quot;</span><span class="p">)</span>
		<span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="nx">transitionDuration</span><span class="p">)</span>
			<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y2&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">height</span> <span class="o">==</span> <span class="s2">&quot;area&quot;</span><span class="p">)</span>
						<span class="k">return</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">areas</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Land_area_million_km2</span><span class="p">);</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">height</span> <span class="o">==</span> <span class="s2">&quot;population&quot;</span><span class="p">)</span>
						<span class="k">return</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">popPercents</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Percent_World_Population</span><span class="p">);</span>
					<span class="k">else</span>
						<span class="k">return</span> <span class="nx">barHeight</span><span class="p">;</span>
				<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <h3>redraw the Tick Labels</h3>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">vis</span><span class="p">.</span><span class="nx">selectAll</span><span class="p">(</span><span class="s2">&quot;text.rule&quot;</span><span class="p">)</span>
		<span class="p">.</span><span class="nx">transition</span><span class="p">().</span><span class="nx">duration</span><span class="p">(</span><span class="nx">transitionDuration</span><span class="p">)</span>
			<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">display</span> <span class="o">==</span> <span class="s2">&quot;timeline&quot;</span><span class="p">)</span>
						<span class="k">return</span> <span class="nx">scales</span><span class="p">.</span><span class="nx">years</span><span class="p">(</span><span class="nx">d</span><span class="p">);</span>
					<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">display</span> <span class="o">==</span> <span class="s2">&quot;centered&quot;</span><span class="p">)</span>
						<span class="k">return</span> <span class="nx">visCenter</span><span class="p">;</span>
					<span class="k">else</span>
						<span class="k">return</span> <span class="nx">padding</span><span class="p">.</span><span class="nx">left</span><span class="p">;</span>
				<span class="p">})</span>
			<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span>
			<span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;dy&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
			<span class="p">.</span><span class="nx">style</span><span class="p">(</span><span class="s2">&quot;fill-opacity&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">d</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="nx">controls</span><span class="p">.</span><span class="nx">display</span> <span class="o">==</span> <span class="s2">&quot;timeline&quot;</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="k">else</span> <span class="p">{</span>
					<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>		
				<span class="p">});</span>

<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <h2>Configure Interaction Events (called only once)</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/************************************************************</span>
<span class="cm"> * Add interaction events after initial drawing</span>
<span class="cm"> ***********************************************************/</span>
<span class="kd">function</span> <span class="nx">addInteractionEvents</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>This will set up the click event on every single bar that was drawn, with the result that if the user clicks on one of the
bars, the InfoBox specific to that bar will be shown</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;g.barGroup&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">showInfoBox</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">));</span>
	<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Configure so that a click that is NOT on a bar will (ultimately) hide the InfoBox</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;.vis .background, .vis .mouseLine&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">showInfoBox</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="kc">null</span><span class="p">);</span>
	<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>Note: if this will be used on mobile devices, it is probably worth checking out hooking up to touch events rather than
click events for responsiveness purposes.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <hr />

<h2>Show InfoBox</h2>             </td>             <td class="code">               <div class="highlight"><pre><span class="cm">/************************************************************</span>
<span class="cm"> * Display info box for data index i, at mouse</span>
<span class="cm"> ***********************************************************/</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Show the InfoBox for a particular empire, or simply hide the InfoBox
if <code>i</code> is null</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">showInfoBox</span><span class="p">(</span><span class="nx">e</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">==</span> <span class="kc">null</span><span class="p">)</span>
		<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#infobox&quot;</span><span class="p">).</span><span class="nx">hide</span><span class="p">();</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">d</span> <span class="o">=</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Build up the html for the InfoBox</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">info</span> <span class="o">=</span> <span class="s2">&quot;&lt;span class=&#39;title&#39;&gt;&quot;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Name</span> <span class="o">+</span> <span class="s2">&quot;&lt;/span&gt;&quot;</span><span class="p">;</span>
		<span class="nx">info</span> <span class="o">+=</span> <span class="s2">&quot;&lt;br /&gt;&quot;</span> <span class="o">+</span> <span class="nx">formatYear</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Start</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="nx">formatYear</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">End</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Land_area_million_km2</span><span class="p">))</span>
			<span class="nx">info</span> <span class="o">+=</span> <span class="s2">&quot;&lt;br /&gt;&quot;</span> <span class="o">+</span> <span class="s2">&quot; Peak (&quot;</span> <span class="o">+</span> <span class="nx">formatYear</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Peak</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;): &quot;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Land_area_million_km2</span> <span class="o">+</span> <span class="s2">&quot; million sq km&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Estimated_Population</span><span class="p">))</span>
			<span class="nx">info</span> <span class="o">+=</span> <span class="s2">&quot;&lt;br /&gt;&quot;</span> <span class="o">+</span> <span class="nx">d</span><span class="p">.</span><span class="nx">Estimated_Population</span> <span class="o">+</span> <span class="s2">&quot; million people in &quot;</span> <span class="o">+</span> <span class="nx">formatYear</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Population_Year</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="nx">info</span> <span class="o">+=</span> <span class="s2">&quot;&lt;br /&gt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;no population data available&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">isNaN</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Percent_World_Population</span><span class="p">))</span>
			<span class="nx">info</span> <span class="o">+=</span> <span class="s2">&quot;&lt;br /&gt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;(&quot;</span> <span class="o">+</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Percent_World_Population</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;% of world population)&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nx">Contiguous</span> <span class="o">===</span> <span class="kc">false</span><span class="p">)</span>
			<span class="nx">info</span> <span class="o">+=</span> <span class="s2">&quot;&lt;br /&gt;&quot;</span> <span class="o">+</span> <span class="s2">&quot;non-contiguous&quot;</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Determine where the InfoBox will be going on the screen;
if the bar clicked is in the top half, use the [mouse coordinates] where the user clicked,
otherwise shift back to the left and up a little big (in case the box is near the bottom of the screen)</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="kd">var</span> <span class="nx">infoPos</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="nx">i</span> <span class="o">&lt;=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
			<span class="nx">infoPos</span> <span class="o">=</span> <span class="p">{</span>
				<span class="nx">left</span> <span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span><span class="p">,</span>
				<span class="nx">top</span> <span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span>
			<span class="p">};</span>
		<span class="k">else</span>
			<span class="nx">infoPos</span> <span class="o">=</span> <span class="p">{</span>
				<span class="nx">left</span> <span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">-</span> <span class="mi">200</span><span class="p">,</span>
				<span class="nx">top</span> <span class="o">:</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span> <span class="o">-</span> <span class="mi">80</span>
			<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <ol>
<li>Shove the <code>info</code> html we just built into the <code>#infobox</code> div element,</li>
<li>Set its position in CSS</li>
<li>Then show it, show it, show it...</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#infobox&quot;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">info</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="nx">infoPos</span><span class="p">).</span><span class="nx">show</span><span class="p">();</span>
	<span class="p">}</span>

<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <h2>Set Current View Options</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>This sets either controls.display or controls.height; it is called from the initialization routine and from the script in the html itself</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">setControl</span><span class="p">(</span><span class="nx">elem</span><span class="p">,</span> <span class="nx">con</span><span class="p">,</span> <span class="nx">val</span><span class="p">,</span> <span class="nx">re</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>Remove the CSS "active" class for any sibling elements, by:</p>

<ol>
<li>Finding the parent elements that have class ".controlGroup" via <a href="http://api.jquery.com/parents/">jQuery's parents() function</a></li>
<li>Finding the "a" descendants of the parents via <a href="http://api.jquery.com/find/">jQuery's find() function</a></li>
<li>Removing the CSS "active" class via <a href="http://api.jquery.com/removeclass/">jQuery's removeClass() function</a></li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">$</span><span class="p">(</span><span class="nx">elem</span><span class="p">).</span><span class="nx">parents</span><span class="p">(</span><span class="s2">&quot;.controlGroup&quot;</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Make sure the passed in element has its CSS class set to "active", using the <a href="http://api.jquery.com/addclass/">jQuery addClass() function</a></p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">$</span><span class="p">(</span><span class="nx">elem</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s2">&quot;active&quot;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p>Set controls.display or controls.height (could be any property, but only "display" and "height" are passed in for "con" in this example)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nx">controls</span><span class="p">[</span><span class="nx">con</span><span class="p">]</span> <span class="o">=</span> <span class="nx">val</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>If the caller wants us to redraw now, do so</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="nx">re</span> <span class="o">==</span> <span class="kc">true</span><span class="p">)</span>
		<span class="nx">redraw</span><span class="p">();</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <hr />             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>This function doesn't seem to be called anywhere</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">parseTransform</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">s</span><span class="p">.</span><span class="nx">substr</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;translate(&quot;</span><span class="p">)</span> <span class="p">{</span>
		<span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nx">s</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="nx">s</span> <span class="o">=</span> <span class="nx">s</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">);</span>
		<span class="kd">var</span> <span class="nx">v1</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span>
		<span class="kd">var</span> <span class="nx">v2</span> <span class="o">=</span> <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">s</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="p">{</span>
		<span class="nx">val1</span> <span class="o">:</span> <span class="nx">v1</span><span class="p">,</span>
		<span class="nx">val2</span> <span class="o">:</span> <span class="nx">v2</span>
	<span class="p">};</span>
<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <hr />

<h2>Date Format Helper</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>Helper function to format dates that are BCE</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">formatYear</span><span class="p">(</span><span class="nx">y</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nx">y</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nx">y</span> <span class="o">*</span> <span class="o">-</span><span class="mi">1</span> <span class="o">+</span> <span class="s2">&quot; BCE&quot;</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="nx">y</span><span class="p">;</span>
<span class="p">}</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 